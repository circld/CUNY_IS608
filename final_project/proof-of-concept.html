<!DOCTYPE html>
<meta charset="utf-8">
<style>

  html, body {
    height: 100%;
    min-height: 100%;
  }

  .dropdown-menu {
    width: 100%;
  }

  /* allow newlines in tooltips, !important to override BS3 defaults */
  .tooltip-inner {
    text-align: left !important;
    max-width: 500px !important;
    white-space: pre-wrap;
  }

  .pad-button-bottom {
    margin-bottom: 0.2%;
  }

  .pad-bottom {
    margin-bottom: 1%;
  }

</style>
<title>Denver Crime Map</title>
<head>
  <!-- load jquery BEFORE bootstrap for tooltips, etc to work properly -->
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="http://bootswatch.com/darkly/bootstrap.min.css">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <script src="heatmap.js"></script>
  <script src="leaflet-heatmap.js"></script>
  <title>Denver Crime Map</title>
</head>


<body class="container-fluid">
<h3 id="top" class="well well-xs text-center">Denver Crime Map
  <br><small>Geographic and temporal crime trends (March 2015)</small></h3>
<div id="controls" data-toggle="tooltip" title="help text not injected">
  <div class="row-fluid">
    <div class="col-xs-12 pad-button-bottom">
      <div class="dropdown" >
        <button type="button" class="btn btn-default btn-block btn-xs"
                id="crime-button" data-toggle="dropdown">
          Select crime category <span class="caret"></span></button>
        <ul class="dropdown-menu" id="crime">
          <!-- menu items generated by d3 -->
        </ul>
      </div>
    </div>
  </div>
  <div class="row-fluid">
    <div class="col-xs-12 pad-button-bottom">
      <div class="dropdown">
        <button type="button" class="btn btn-default btn-block btn-xs"
                id="time-button" data-toggle="dropdown">
          Select time unit <span class="caret"></span></button>
        <ul class="dropdown-menu" id="time-unit">
          <li><a href="#" onclick="set_unit('linear');">Linear</a></li>
          <li><a href="#" onclick="set_unit('hour');">Aggregate by hour</a></li>
          <li><a href="#" onclick="set_unit('day');">Aggregate by day of the week</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="row-fluid">
    <div class="col-xs-12 pad-bottom">
      <button type="button" id="start" class="btn btn-success btn-block btn-xs"
              onclick="animate_map();">Run visualization</button>
    </div>
  </div>
</div>
<div id="map-row" class="row-fluid">
  <div class="col-xs-12">
    <div id="map" class=""></div>
  </div>
</div>
<div class="row-fluid">
  <div class="col-xs-12">
    <p class="text-muted" id="date_display"></p>
  </div>
</div>


<script type="text/javascript">

  // inject help text into tooltip
  var help_text = "1. Select crime category of interest\n" +
      "2. Press 'Run Visualization' to begin heatmap animation\n" +
      "3. Press 'Stop Visualization' to stop animation and to reset";
  d3.select("#controls")
      .attr("title", help_text);

  // define local data location
  var fname = 'crime_cats_201503';
  var data_fpath = 'data/' + fname + '.topojson';

  var n = {
    'linear': 14,
    'hour': 3,
    'day': 2
  };  // max datum val/intervals visible (?)
  var speed = {
    'linear': 500,
    'hour': 800,
    'day': 1200
  };

  // declare global vars (for debug)
  var full_data = [];
  var features;
  var crimes;
  var crime_selected;
  var time_unit;
  var intervals;  // need global access to cancel

  ///////////// heatmap.js /////////////
  var config = {
    "radius": 15,
    "maxOpacity": 0.9,
    "minOpacity": 0,
    "scaleRadius": false,
    "useLocalExtrema": false,
    "blur": 0.75,
//    gradient: {
//      '0.05': '#ffffcc',
//      '0.25': '#a1dab4',
//      '0.5': '#41b6c4',
//      '0.75': '#2c7fb8',
//      '0.95': '#253494'
//    },
    latField: 'lat',
    lngField: 'lng',
    valueField: 'val'
  };

  // initialize heatmap overlay
  var heatmap = new HeatmapOverlay(config);

  var heatmap_data;  // set in set_unit

  ///////////// leaflet.js ////////////
  function map_height () {
    return $(window).height()
        - $("#map-row").offset().top
        - $(document).scrollTop();
  }

  function resize(){
    $('#map').css("height", map_height());
  }

  $('#map').css("height", map_height());

  $(window).on("resize", resize);
  resize();

  var base = new L.TileLayer(
      "http://{s}.tiles.mapbox.com/v4/circld.b689c053/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY2lyY2xkIiwiYSI6IjE5MjJCN2MifQ.Ztr1z4FvXHYHFQCxEubPpw"
  );

  var map = L.map('map', {
    center: new L.LatLng(39.737, -104.981),
    zoomControl: false,
    minZoom: 12,
    maxZoom: 13,
    zoom: 13,
    layers: [base, heatmap]
  });

  //////////// animation ////////////
  // add capitalize string method
  String.prototype.capitalize = function() {
    // replace hyphens and cap first letter in each word
    return this.replace(/-/g, ' ')
        .replace(/\b\w/g, function (m) {
          return m.toUpperCase();
        });
  };

  function set_unit(unit) {
    time_unit = unit;

    heatmap_data = {
      max: 4 * n[time_unit],  // what's an appropriate scaling factor for max?
      min: 0,
      data: []
    };


    var labels = {
      "linear": "Linear",
      "hour": "Aggregate by hour",
      "day": "Aggregate by day"
    };
    d3.select("#time-button")
        .html(labels[time_unit] + ' <span class="caret"></span>')
  }

  function aggregate(datetime) {
    if (time_unit === "linear") {
      return datetime.getDate();
    } else if (time_unit === "hour") {
      return datetime.getHours();
    } else {
      return datetime.getDay();
    }
  }

  // helper function to push features data into full_data
  function get_coords(element, index, array) {

    var el_type = element.properties.OFFENSE_CATEGORY_ID;

    if (crime_selected === 'all' || crime_selected === el_type) {
      full_data.push({
//        datetime: new Date(element.properties.FIRST_OCCURRENCE_DATE),
        crime: el_type,
        shown: false,
        unit: aggregate(new Date(element.properties.FIRST_OCCURRENCE_DATE)),

        // required heatmap.js vars
        lat: element.geometry.coordinates[1],
        lng: element.geometry.coordinates[0],
        val: 0
      });
    }
  }

  // reset for next animation
  function reset() {
    clearInterval(intervals);
    toggle_run();

    heatmap_data.data = [{
      // dummy point to ensure all heatmap points removed from map
      lat: 0.0,
      lng: 0.0,
      val: 0
    }];
    heatmap.setData(heatmap_data);

    full_data = [];
    $(window).scrollTop(0);
    return true;
  }

  // toggle run viz button
  function toggle_run() {

    if (!(crime_selected)) {
      return false;
    }

    var button = d3.select("#start");
    if (button.text() === 'Run visualization') {
      button.text("Stop visualization")
          .attr("onclick", "reset();")
          .classed({ "btn-danger": true , "btn-success": false});
    } else {
      button.text("Run visualization")
          .attr("onclick", "animate_map();")
          .classed({ "btn-success": true , "btn-danger": false});
    }
  }

  // run heatmap animation
  function animate_map() {

    if (!(crime_selected)) {
      return false;
    }

    toggle_run();

    // populate heatmap_data arrays
    features.forEach(get_coords);

    // determine date range
    var datetime_extent = d3.extent(full_data, function(d) {
      return d.unit;
    });

    if (!(datetime_extent)) {
      alert("No observations.");
    }

    // must create new date or will overwrite datetime for datum
    var curr_time = datetime_extent[0];
    var last_time = datetime_extent[1];

    console.log(curr_time);
    console.log(last_time);
    last_time += 4 * n[time_unit];  // to allow points to fade

    function add_next_data() {

      // change curr_time
      curr_time += 1;

      // update current data slice in heatmap_data.data
      heatmap_data.data.forEach(function (element, array, index) {
        if (element.shown && element.val === 0) {
          heatmap_data.data.splice(index, 1);
        }
        if (element.val > 0) {
          element.val -= 1;
        }
      });

      // push qualifying points from full_data into heatmap_data.data
      // note: will need to reset shown & val if reusing full_data
      full_data.forEach( function(element, array, index) {
        if (!element.shown && element.unit < curr_time) {
          element.shown = true;
          element.val = n[time_unit];
          heatmap_data.data.push(element);
        }
      });

      // display curr_time in DOM object
      if (curr_time <= datetime_extent[1]) {
        d3.select("#date_display")
            .text(curr_time);
      } else {
        d3.select("#date_display")
            .text(" ");
      }

      // update map data points
      heatmap.setData(heatmap_data);

      // reset once current_time > last_time
      if (curr_time > last_time) {
        console.log(heatmap_data.data.filter(function(element, array, index) {
          return element.val === 0;
        }));
        clearInterval(intervals);
        return reset();
      }
    }

    // call add_next_data for each speed interval
    intervals = setInterval(add_next_data, speed[time_unit]);

    // scroll to see dates (must wait until date is displayed)
    setTimeout("$(window).scrollTop( $(document).height());", speed[time_unit] + 1);

  }

  //////////// Reading data & dynamic DOM generation/manipulation ///////////
  d3.json(data_fpath, function(error, data) {

    if (error) return console.error(error);

    // store data in global var
    features = topojson.feature(data, data.objects[fname]).features;

    // crime types
    crimes = d3.set();
    features.forEach(
        function(el, ar, idx) {
          crimes.add(el.properties.OFFENSE_CATEGORY_ID);
        }
    );
    crimes = crimes.values().sort();
    crimes.unshift('all');

    // create crime type dropdown items
    d3.select("#crime")
        .selectAll("li")
        .data(crimes)
        .enter()
        .append("li")
        .append("a")
        .attr("href", "#")
        .text(function(d) { return d.capitalize(); })
        // add event listeners for items (update button text accordingly)
        .on("click", function(d, i) {
          crime_selected = crimes[i];
          d3.select("#crime-button")
              .html(
                  crime_selected.capitalize() + ' <span class="caret"></span>'
          );
        });

  });

  // initialize tooltip(s)
  $(document).ready(function() {
    $('[data-toggle="tooltip"]').tooltip();
  });
</script>
