<!DOCTYPE html>
<meta charset="utf-8">
<style>

  #map { width: 600px; height: 500px; }
  path {
    fill-opacity: .2;
  }

</style>
<title>Denver Crime Map Proof-of-concept</title>
<head>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
</head>
<body>
<div id="map"></div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="heatmap.js"></script>
<script src="leaflet-heatmap.js"></script>

<script type="text/javascript">

  // define local data location
  var data_fpath = 'data/crime_sample.topojson';

  // heatmap.js
  var config = {
    "radius": 15,
    "maxOpacity": 0.65,
    "scaleRadius": false,
    "useLocalExtrema": true,
    latField: 'lat',
    lngField: 'lng',
    valueField: 'val'
  };

  // read in data
  d3.json(data_fpath, function(error, data) {

    if (error) return console.error(error);

    var heatmap_data = {
        max: 14,
        data: []
    };

    function get_coords(element, index, array) {
      heatmap_data.data.push({
        datetime: new Date(element.properties.FIRST_OCCURRENCE_DATE),

        // required heatmap.js vars
        lat: element.geometry.coordinates[1],
        lng: element.geometry.coordinates[0],
        val: 0
      });
    }

    var features = topojson.feature(data, data.objects.crime_sample).features;

    // set up leaflet map tile
    var base = new L.TileLayer(
      "http://{s}.tiles.mapbox.com/v4/circld.b689c053/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY2lyY2xkIiwiYSI6IjE5MjJCN2MifQ.Ztr1z4FvXHYHFQCxEubPpw"
    );

    // initialize heatmap overlay
    var heatmap = new HeatmapOverlay(config);

    var map = L.map('map', {
      center: new L.LatLng(39.737, -104.981),
      zoom: 12,
      maxZoom: 13,
      minZoom: 11,
      layers: [base, heatmap]
    });

    // populate heatmap_data arrays
    features.forEach(get_coords);

    // add data by 12 hour intervals
    var datetime_extent = d3.extent(heatmap_data.data, function(d) {
      return d.datetime;
    });
    var curr_time = datetime_extent[0];
    var last_time = datetime_extent[1];
    curr_time.setMinutes(0);
    last_time.setMinutes(0);
    last_time.setHours(last_time.getHours() + 12);

    function add_next_data() {
      // change curr_time
      if (curr_time.getHours() < 12) {
        curr_time.setHours(12);
      } else {
        curr_time.setDate(curr_time.getDate() + 1);
        curr_time.setHours(0);
      }

      heatmap_data.data.forEach(function (d) {
        if (d.val > 0) {
          d.val -= 1;
        }
        if (d.datetime < curr_time && d.val === 0) {
          d.val = 14;
        }

      console.log(curr_time);
      });

      heatmap.setData(heatmap_data);
    }

    var intervals = setInterval(add_next_data, 1500);
    if (curr_time > last_time) {
      clearInterval(intervals);
    }

  });

</script>
